<!DOCTYPE html>
<html>
<head>
  <title>Rendering Micro Benchmark</title>
</head>
<body>
  <div id="benchmarkContainer">
    <style>
      body {
        font-family: sans-serif;
      }
      #container {
        display: flex;
      }
      #input, #preview {
        width: 50%;
        padding: 10px;
        border: 1px solid #ccc;
      }
      #input {
        white-space: pre;
        overflow-x: auto;
      }
      #preview {
        background-color: #f5f5f5;
      }
      #previewTitle {
        margin-bottom: 5px;
      }
      #run {
        margin: 10px 0;
        padding: 8px 16px;
      }
      .warning {
        padding: 10px;
        background: orange;
        color: white;
        margin-bottom: 15px;
      }
    </style>
    <h1>Rendering Micro Benchmark</h1>
    <p>Enter HTML snippets below to benchmark their performance.</p>

    <div id="container">
      <textarea id="input" rows="10"></textarea>
      <div id="preview">
        <h2>Preview</h2>
        <div id="previewContent"></div>
      </div>
    </div>

    <button id="run">Run Benchmark</button>

    <h2>Results</h2>
    <div id="results"></div>
  </div>

  <script type="module">
    import { benchmark, Snippet, TimeStats } from './src/runner.js';

    onload = () => {
      input.addEventListener('input', () => {
        updatePreviewContent();
        updateUrlHashForSharing();
      });

      run.addEventListener('click', () => {
        runBenchmark();
      });

      // If set, use the window location hash for snippets. Otherwise, use a set
      // of predefined examples.
      const hash = window.location.hash.substring(1);
      input.value = hash ? atob(hash) : examples.trim();
      updatePreviewContent();

      checkCrossOriginIsolated();
    }

    function updatePreviewContent() {
      previewContent.innerHTML = '';
      for (const snippet of getSnippets())
        previewContent.innerHTML += `<h4>${snippet.name}</h4>${snippet.html}`;
    }

    function updateUrlHashForSharing() {
      const encodedHTML = btoa(input.value);
      const newURL = window.location.origin + window.location.pathname + '#' + encodedHTML;
      window.history.replaceState({}, '', newURL);
    }

    async function runBenchmark() {
      const snippets = getSnippets();
      let benchmarkContainer = document.getElementById('benchmarkContainer');
      document.body.removeChild(benchmarkContainer);

      let snippetStats = await benchmark(snippets, document.body);

      document.body.replaceChildren(benchmarkContainer);

      let resultsText = '';
      function format(num) { return parseFloat(num.toFixed(2)); }
      for (const stats of snippetStats) {
        resultsText += `<b>${stats.name}: ${format(stats.totalTimeAvg)} ms</b>
          (stddev: ${format(stats.totalTimeStdDev)} ms):<br>`;
        resultsText += `  parse avg: ${format(stats.parseTimeAvg)} ms
          (stddev: ${format(stats.parseTimeStdDev)} ms)<br>`;
        resultsText += `  styleLayout avg: ${format(stats.styleLayoutTimeAvg)} ms
          (stddev: ${format(stats.styleLayoutTimeStdDev)} ms)<br>`;
        resultsText += `  paint avg: ${format(stats.paintTimeAvg)} ms
          (stddev: ${format(stats.paintTimeStdDev)} ms)<br><br>`;
      }
      results.innerHTML = resultsText;
    }

    // Return an array of `Snippet`s from #input.
    function getSnippets() {
      let snippets = [];
      let scratch = document.createElement('div');
      scratch.innerHTML = input.value;
      for (const div of scratch.querySelectorAll('snippet'))
        snippets.push(new Snippet(div.getAttribute('name'), div.innerHTML));
      return snippets;
    }

    // If the page is not loaded with cross-origin isolation headers, timer
    // precision (performance.now(), etc.) is much worse. Below is a comparison
    // with vs without isolation:
    //   Chromium: 5us vs 100us
    //   WebKit: 20us vs 1000us
    //   Gecko: 100us vs 1000us
    function checkCrossOriginIsolated() {
      if (!self.crossOriginIsolated) {
        var warning = document.createElement('div');
        warning.classList.add('warning');
        const crossOriginDocs =
          'https://developer.mozilla.org/en-US/docs/Web/API/Window/crossOriginIsolated';
        warning.innerHTML = `<b>Warning:</b> Timer precision is reduced because
        this page is not <a href="${crossOriginDocs}">cross-origin isolated</a>.
        Fix by using <code>python3 server.py</code>.`;
        document.body.insertBefore(warning, document.body.firstChild);
      }
    }

    const examples = `
<snippet name="svg-image">
  <style>
    .svg-image {
      display: inline-block;
      height: 24px;
      width: 24px;
      background-image: url('data:image/svg+xml,<svg uinqueid="svg-image" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="%23747878" d="M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z"></path></svg>');
    }
  </style>
  <div class="svg-image"></div>
</snippet>

<snippet name="inline-svg">
  <style>
    .inline-svg {
      display: inline-block;
      height: 24px;
      width: 24px;
      fill: #747878;
    }
  </style>
  <svg class="inline-svg" focusable="false" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
    <path d="M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z"></path>
  </svg>
</snippet>

<snippet name="css-clip-path">
  <style>
    .css-clip-path {
      clip-path: path('M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z');
      display: inline-block;
      height: 24px;
      width: 24px;
      background-color: #747878;
    }
  </style>
  <div class="css-clip-path"></div>
</snippet>`;
  </script>
</body>
</html>
