<!DOCTYPE html>
<html>
<head>
  <title>Rendering Micro Benchmark</title>
  <style>
    body {
      font-family: sans-serif;
    }
    #container {
      display: flex;
    }
    #input, #preview {
      width: 50%;
      padding: 10px;
      border: 1px solid #ccc;
    }
    #input {
      white-space: pre;
      overflow-x: auto;
    }
    #preview {
      background-color: #f5f5f5;
    }
    #previewTitle {
      margin-bottom: 5px;
    }
    #run {
      margin: 10px 0;
      padding: 8px 16px;
    }
    #warnings {
      display: none;
      background-color: bisque;
      border: 1px solid redbrick;
    }
  </style>
</head>
<body>
  <h1>Rendering Micro Benchmark</h1>
  <p>Enter HTML snippets below to benchmark their performance.</p>
  <p id="warnings"></p>

  <div id="container">
    <textarea id="input" rows="10"></textarea>
    <div id="preview">
      <h2>Preview</h2>
      <div id="previewContent"></div>
    </div>
  </div>

  <button id="run">Run Benchmark</button>

  <h2>Results</h2>
  <div id="results"></div>

  <script type="module">
    import { benchmark, Snippet, Times } from './src/runner.js';

    onload = () => {
      input.addEventListener('input', () => {
        updatePreviewContent();
        updateUrlHashForSharing();
      });

      run.addEventListener('click', () => {
        runBenchmark();
      });

      showTimerQuantizationWarningIfNeeded();

      // If set, use the window location hash for snippets. Otherwise, use a set
      // of predefined examples.
      const hash = window.location.hash.substring(1);
      input.value = hash ? atob(hash) : examples.trim();
      updatePreviewContent();
    }

    function updatePreviewContent() {
      previewContent.innerHTML = '';
      for (const snippet of getSnippets())
        previewContent.innerHTML += `<h4>${snippet.name}</h4>${snippet.html}`;
    }

    function updateUrlHashForSharing() {
      const encodedHTML = btoa(input.value);
      const newURL = window.location.origin + window.location.pathname + '#' + encodedHTML;
      window.history.replaceState({}, '', newURL);
    }

    async function runBenchmark() {
      let resultTimes = await benchmark(getSnippets(), results);

      results.innerHTML = '';
      for (const times of resultTimes) {
        let total = times.parseTime + times.styleLayoutTime + times.paintTime;
        results.innerHTML += `<b>${times.name}: ${parseFloat(total.toFixed(3))} ms</b>:<br>`;
        results.innerHTML += `  parse: ${parseFloat(times.parseTime.toFixed(3))} ms<br>`;
        results.innerHTML += `  styleLayout: ${parseFloat(times.styleLayoutTime.toFixed(3))} ms<br>`;
        results.innerHTML += `  paint: ${parseFloat(times.paintTime.toFixed(3))} ms<br><br>`;
      }
    }

    // Return an array of `Snippet`s from #input.
    function getSnippets() {
      let snippets = [];
      let scratch = document.createElement('div');
      scratch.innerHTML = input.value;
      for (const div of scratch.querySelectorAll('snippet'))
        snippets.push(new Snippet(div.getAttribute('name'), div.innerHTML));
      return snippets;
    }

    function showTimerQuantizationWarningIfNeeded() {
      if (!self.crossOriginIsolated) {
        warnings.style.display = 'inline';
        warnings.innerHTML = '<b>Warning:</b> Timer precision impacted because not <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/crossOriginIsolated">cross-origin isolated</a>. Use <code>python3 crossOriginIsolatedServer.py</code>.</p>';
      }
    }

    const examples = `
<snippet name="svg-image">
  <style>
    .svg-image {
      display: inline-block;
      height: 24px;
      width: 24px;
      background-image: url('data:image/svg+xml,<svg uinqueid="svg-image" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="%23747878" d="M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z"></path></svg>');
    }
  </style>
  <div class="svg-image"></div>
</snippet>

<snippet name="inline-svg">
  <style>
    .inline-svg {
      display: inline-block;
      height: 24px;
      width: 24px;
      fill: #747878;
    }
  </style>
  <svg class="inline-svg" focusable="false" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
    <path d="M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z"></path>
  </svg>
</snippet>

<snippet name="css-clip-path">
  <style>
    .css-clip-path {
      clip-path: path('M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z');
      display: inline-block;
      height: 24px;
      width: 24px;
      background-color: #747878;
    }
  </style>
  <div class="css-clip-path"></div>
</snippet>`;
  </script>
</body>
</html>
