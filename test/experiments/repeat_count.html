<!DOCTYPE html>
<!--
  This experiment locates an ideal repeat count. Run in each browser and import
  into Google Sheets with Edit>Paste Special>CSV as columns.

  https://docs.google.com/spreadsheets/d/1G6evOb6HbQxo6SHafs_Ok0EFKkedvF-gxkJ26HuKRcs/edit?usp=sharing
-->
<html>
<body>
  <div id="results"></div>

  <script type="module">
    import { benchmark, Snippet, TimeStats, TestInternals } from '../../src/runner.js';
    const { getTimeStats, benchmarkInternal, generateUnique, RawTimes } = TestInternals;

    async function waitForTimeout(t = 0) {
      return new Promise((resolve, reject) => setTimeout(resolve, t))
    }

    function formatNumber(num) {
      return parseFloat(num.toFixed(3));
    }

    // Configuration.
    let repeats = [
      5, 10, 20, 50, 100, 200,
      5, 10, 20, 50, 100, 200,
      5, 10, 20, 50, 100, 200];
    function repeatName(i) {
      return `repeat_${repeats[i]}`;
    }

    // Setup the tests in `snippetsMap` and `rawTimesMap`.
    let snippetsMap = {};
    let rawTimesMap = {};
    for (const [i, repeat] of repeats.entries()) {
      let name = repeatName(i);
      let inputSnippet = [new Snippet(name,
        `<style>
          .${name} {
            display: inline-block;
            height: 24px;
            width: 24px;
            background-image: url('data:image/svg+xml,<svg uinqueid="${name}" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="%23747878" d="M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z"></path></svg>');
          }
        </style>
        <div class="${name}"></div>`)];
      snippetsMap[i] = generateUnique(inputSnippet, repeat);
      // No need to shuffle since we only have a single snippet.
      let rawTimes = [];
      for (const snippet of snippetsMap[i])
        rawTimes.push(new RawTimes());
      rawTimesMap[i] = rawTimes;
    }

    // Run the benchmark.
    for (const [i, repeat] of repeats.entries()) {
      await waitForTimeout(1000);
      await benchmarkInternal(snippetsMap[i], rawTimesMap[i], results, /* debugTimestamps */ false, /* keepWarm */ true);
    }

    // Group by repeat count.
    let originalSnippetsMap = snippetsMap;
    let originalRawTimesMap = rawTimesMap;
    snippetsMap = {};
    rawTimesMap = {};
    for (const [i, repeat] of repeats.entries()) {
      if (!snippetsMap[repeat]) {
        snippetsMap[repeat] = [];
        rawTimesMap[repeat] = [];
      }
      snippetsMap[repeat].push(...originalSnippetsMap[i]);
      rawTimesMap[repeat].push(...originalRawTimesMap[i]);
    }

    // Dump the stats for each test.
    let statsHtml = 'Test, parseAvg, styleLayoutAvg, paintAvg, totalAvg, '
      + 'parseStdDev, styleLayoutStdDev, paintStdDev, totalStdDev';
    for (const i of Object.keys(snippetsMap)) {
      let name = snippetsMap[i][0].name;
      const stat = getTimeStats(snippetsMap[i], rawTimesMap[i], [name])[0];
      statsHtml += '<br>' + name;
      statsHtml += ', ' + formatNumber(stat.parseTimeAvg);
      statsHtml += ', ' + formatNumber(stat.styleLayoutTimeAvg);
      statsHtml += ', ' + formatNumber(stat.paintTimeAvg);
      statsHtml += ', ' + formatNumber(stat.totalTimeAvg);
      statsHtml += ', ' + formatNumber(stat.parseTimeStdDev);
      statsHtml += ', ' + formatNumber(stat.styleLayoutTimeStdDev);
      statsHtml += ', ' + formatNumber(stat.paintTimeStdDev);
      statsHtml += ', ' + formatNumber(stat.totalTimeStdDev);
    }
    results.innerHTML = statsHtml;

    // Dump the raw times for each test.
    let rawParseTimesHtml = 'Raw Parse Times';
    let rawStyleLayoutTimesHtml = 'Raw StyleLayout Times';
    let rawPaintTimesHtml = 'Raw Paint Times';
    for (const i of Object.keys(snippetsMap)) {
      let name = snippetsMap[i][0].name;
      rawParseTimesHtml += '<br>' + name;
      rawStyleLayoutTimesHtml += '<br>' + name;
      rawPaintTimesHtml += '<br>' + name;
      for (const [snippetIndex, snippet] of snippetsMap[i].entries()) {
        rawParseTimesHtml += ', ' + formatNumber(rawTimesMap[i][snippetIndex].parseTime);
        rawStyleLayoutTimesHtml += ', ' + formatNumber(rawTimesMap[i][snippetIndex].styleLayoutTime);
        rawPaintTimesHtml += ', ' + formatNumber(rawTimesMap[i][snippetIndex].paintTime);
      }
    }
    results.innerHTML += '<br><br>' + rawParseTimesHtml;
    results.innerHTML += '<br><br>' + rawStyleLayoutTimesHtml;
    results.innerHTML += '<br><br>' + rawPaintTimesHtml;
  </script>
</body>
</html>
